# SQL 檔案的說明

此目錄中的所有檔案主要都是基礎的 SQL 表格構建指令碼. 當全新安裝或者是升級版本的時候, 可能都需要用到. 該文件主要對此目錄下的檔案進行介紹, 讓大家對如何使用該目錄中的各種檔案有一個簡單的瞭解.

特別是, 當 rAthena 開始將物品和其他資料庫陸續從以前的 CSV 改造成 YAML 格式後, 資料庫部分的內容有了較大的調整, 哪怕是老玩家也需要重新瞭解一下.


概念定義
============================================

熊貓模擬器基於 rAthena 模擬器構建, 可以看做是 rAthena 模擬器的 MOD 版. 他們的大多數基礎概念是相同的, 但熊貓模擬器為了讓初學者使用者比較易懂, 將 sql-files 目錄中的檔案進行了挪動和重構, 因此它與 rAthena 的檔案位置是不同的.

接下來會就一些基礎的概念進行普及, 老玩家請跳過, 新玩家建議仔細閱讀, 有助於你更好的使用熊貓模擬器或者避免一些初學者容易卡住的地方.

## 概念: 資料庫伺服器

熊貓模擬器想要正常執行, 就必然需要一個資料庫伺服器用來儲存玩家的資料. 當前推薦使用 MySQL 作為資料庫伺服器. 之所以稱之為是"伺服器", 是因為它可以對外提供"資料"的儲存和查詢服務. 

一臺資料庫伺服器會擁有它的 IP 和埠, 其中埠通常就是 3306, 還會有資料庫伺服器的賬號密碼. 外部程式必須知道 MySQL 伺服器的 IP, 埠, 賬號, 密碼 這四個要素, 才能與資料庫伺服器建立連線, 才能有機會將資料儲存到它上面去.

通常, 在 `conf/inter_athena.conf` 配置檔案中, 我們會定義好幾組與 MySQL 資料庫伺服器的連線配置, 詳見對應檔案中的說明資訊. 但直接修改 `conf/inter_athena.conf` 並不是一個好主意, 最佳實踐是: 將自己的改動存放到 `conf/import/inter_conf.txt` 中去, 這樣未來當模擬器有更新時你可以放心的將 `conf/inter_athena.conf` 替換成最新版本模擬器的配套檔案, 而無需擔心又需要被重新配置一次.

* 一臺 MySQL 資料庫伺服器 (Database Server) 可以存放多個資料庫 (Database)
* 一個資料庫 (Database) 可以存放多個資料表 (Table)
* 每一個資料表 (Table) 可以有多個欄位 (Field)
* 資料表 (Table) 中的每一行, 稱之為一條記錄 (Record)

不嚴謹的比喻: 

* 每一個資料庫可以相當於一個 Excel 檔案
* 每一個資料表相當於這個 Excel 檔案中的 Sheet
* 每一個欄位相當於這個 Sheet 中的一列
* 每一條記錄相當於這個 Sheet 中的一行

## 概念: 主資料庫

用於存放玩家存檔資料的資料庫, 稱之為"主資料庫" (Main Database). 主資料庫通常就是 `conf/inter_athena.conf::map_server_db` 配置的那一個資料庫. 主資料庫除了存放玩家的存檔資料外, 通常還存放著一些程式執行所需要的資料表.

## 概念: 日誌資料庫

用於存放玩家在遊戲中活動產生的各種日誌記錄的資料庫, 稱之為"日誌資料庫" (Logs Database). 日誌資料庫通常就是 `conf/inter_athena.conf::log_db_db` 配置的那一個資料庫. 它可以和主資料庫是同一個, 但通常我們建議分開. 因為主資料庫的記錄通常比較少但內容十分重要, 而日誌資料庫的記錄會非常多卻沒那麼重要. 當你未來需要對資料庫進行備份的時候, 若主資料庫和日誌資料庫都是相同的一個資料庫, 備份檔案的體積會非常大.

## 概念: WEB 介面資料庫 (簡稱: 介面資料庫)

由於客戶端 20200304 版本開始, 公會圖示等資料已經不再傳遞給地圖伺服器進行儲存, 而是改成使用 HTTP 協議的介面來進行儲存, 因此服務端引進了一個新的 server 用來處理類似的 HTTP 請求, 這個伺服器叫 WEB 介面伺服器, 對應的程式是 `web-server.exe`.

WEB 介面伺服器也需要相關的資料表才能來儲存玩家上傳上來的公會圖示, 快捷鍵設定等資訊. 因此它也有一個自己的資料庫, 我們將他稱為: 介面資料庫. 通常情況下介面資料庫和主資料庫可以是同一個 (我們也推薦初學者這麼做), 這樣備份資料會方便一些. 如果您有特殊原因需要單獨將他拆分開來成為一個獨立的資料庫的話, 只需要在 conf/inter_athena.conf 中調整資料庫連線設定即可.

## 概念: 資料庫編碼

若您是簡體中文使用者, 建立資料庫時選擇的編碼請使用 `gbk`; 若您是繁體中文使用者, 建立資料庫時選擇的編碼請使用 `big5`, 原則上不推薦使用 `utf8` 或 `utf8mb4`, 因為仙境傳說的客戶端在簡體中文和繁體中文的工作模式下, 使用的編碼就是 `gbk` 和 `big5`, 而不是 `utf8` 這種 unicode 編碼.

若您使用熊貓模擬器, 那麼 `conf/inter_athena.conf::default_codepage` 只需要維持預設選項 `auto` 即可. 程式會根據執行服務端程式的作業系統語言, 自動確定編碼. 詳見 `default_codepage` 選項的說明.


全新安裝
============================================

當你全新安裝熊貓模擬器的時候, 需要在你的資料庫伺服器中建立兩個資料庫. 一個是主資料庫, 我們假定名稱為 `pandas_main`, 另一個是日誌資料庫, 我們假定名稱為 `pandas_logs`. 當你建立完成資料庫之後, 需要透過 sql-files 目錄中對應的 SQL 指令碼來建立對應的資料表.

針對 [主資料庫] 您需要進行的操作是:

* 將 `sql-files\main\creation` 目錄中的 sql 檔案按順序匯入到主資料庫中:
    * `sql-files\main\creation\01.main.sql`
    * `sql-files\main\creation\02.roulette_default_data.sql`
* 其中 `optional` 存放著一些可選的指令碼, 暫時不用管, 本文後續會提及他們的作用
* 其中 `use_sql_db` 存放著 SQL 版本的物品和魔物資料庫的建庫指令碼, 一會兒我們會講到

針對 [日誌資料庫] 您需要進行的操作是:

* 將 `sql-files\logs\creation` 目錄中的 sql 檔案按順序匯入到日誌資料庫中:
    * `sql-files\logs\creation\01.logs.sql`

針對 [介面資料庫] 您需要進行的操作是:

* 將 `sql-files\web\creation` 目錄中的 sql 檔案按順序匯入到主資料庫 (或者單獨建立的一個介面資料庫) 中:
    * `sql-files\web\creation\01.web.sql`

細心的同學會發現, 目錄路徑都是被刻意設計過的. `main` 表示主資料庫, `creation` 表示建庫指令碼, 平級的還有 `upgrades` 表示升級指令碼 (後續會講), `optional` 表示可選. `common` 表示公用. 而 SQL 指令碼檔案的命名中, 開頭的 `01`, `02` 則表示匯入的順序.

> 編碼說明: 所有的 sql 指令碼檔案都是 UTF8 編碼, 若您用於匯入指令碼的工具支援選擇 sql 檔案的編碼, 那麼請選擇 UTF8. 新手經常搞混的是: 此處的 SQL 檔案編碼與資料庫的編碼是兩個東西. 你的資料庫可以是 `gbk` 或者 `big5` 編碼, 但負責用來建立表格的 sql 檔案, 它自身的編碼就是 UTF8.

## SQL 版資料

若您的伺服器配置成使用 SQL 版本的物品和魔物資料庫, 那麼還需在主資料庫中額外匯入一些指令碼檔案. 預設情況下熊貓模擬器並未開啟此功能, 但若您手動將 `conf/inter_athena.conf::use_sql_db` 設為 `yes` 那麼意味著程式將去主資料庫中讀取物品和魔物資料庫, 而不是去 `db` 目錄下讀取那些 txt 和 yaml 檔案.

如果您不知道我在說什麼, 可以當做什麼事情都沒發生過, 確保 `conf/inter_athena.conf::use_sql_db` 為 `no` 然後直接跳過接下來的匯入說明, 前往 `升級版本` 章節繼續閱讀.

針對 [主資料庫] 您需要進行的操作是:

* 依序匯入 `sql-files\main\creation\use_sql_db\common` 目錄中的 sql 檔案
    * 此公用目錄中的 sql 檔案, 無論您是復興前還是復興後, 都需要匯入
* 若您的程式編譯成了 `復興前` 版本, 那麼:
    * 請依序匯入 `sql-files\main\creation\use_sql_db\pre-renewal` 目錄中的 sql 檔案
    * 此目錄中的多個 sql 檔案都需要按順序匯入, 順序是重要的, 請不要亂序匯入
* 若您的程式編譯成了 `復興後` 版本, 那麼:
    * 請依序匯入 `sql-files\main\creation\use_sql_db\renewal` 目錄中的 sql 檔案
    * 此目錄中的多個 sql 檔案都需要按順序匯入, 順序是重要的, 請不要亂序匯入
* 你可能會發現 `pre-renewal` 和 `renewal` 目錄下有 `optional` (可選) 目錄, 那裡面的指令碼暫時無需匯入

> 寫給老玩家: 以前 rAthena 中 item_db 可能只需要匯入 1 個 sql 檔案, 就已經包含了建表和資料內容匯入. 但最新的 rAthena 由於將物品資料庫修改成 YAML 格式後, 將 SQL 版的物品資料庫拆分成了四個檔案, 其中 `item_db{_re}.sql` 負責建表, 剩下的 `item_db{_re}_{equip\usable\etc}.sql` 分別包含 `裝備\可用物品\其他道具` 三大類道具的資料. 因此, 相比以前匯入的 sql 檔案多了好幾個, 過程變得更為麻煩.


升級版本
============================================

隨著時間的流逝, 模擬器會有功能上的更新和最佳化, 這有可能導致資料表的結構需要進行調整或者變更. 此時就需要對資料庫進行升級操作. 在熊貓模擬器中用於升級資料庫的指令碼檔案已經被重新歸類和聚合整理, 通常每個版本只需要匯入對應的升級指令碼即可完成升級工作.

以 v1.0.6 升級到 v1.0.8 版本為例子, 我們舉例說明應如何對資料庫進行升級操作.

針對 [主資料庫] 的升級操作如下:

* 首先停止服務端程式的執行
* 將你的 [主資料庫] 完整的匯出成 sql 指令碼檔案, 進行備份
* 開啟 `sql-files\main\upgrades\upgrade_to_1.0.7_main.sql` 閱讀頂部說明, 並將其匯入
* 若啟用了 `use_sql_db` 則還需開啟 `sql-files\main\upgrades\upgrade_to_1.0.7_main_use_sql_db.sql` 閱讀頂部說明, 並將其匯入
* 上述兩個檔案匯入完成後, 你的 [主資料庫] 已經被升級到 v1.0.7
* 開啟 `sql-files\main\upgrades\upgrade_to_1.0.8_main.sql` 閱讀頂部說明, 並將其匯入
* 此時你的 [主資料庫] 已經被升級到 v1.0.8

針對 [日誌資料庫] 的升級操作如下:

* 首先停止服務端程式的執行
* 將你的 [日誌資料庫] 完整的匯出成 sql 指令碼檔案, 進行備份
* 開啟 `sql-files\logs\upgrades\upgrade_to_1.0.7_logs.sql` 閱讀頂部說明, 並將其匯入
* 該檔案匯入完成後, 你的 [日誌資料庫] 已經被升級到 v1.0.7
* 你會發現並沒有 v1.0.8 的 [日誌資料庫] 升級檔案, 這說明 v1.0.7 到 v1.0.8 之間, 日誌資料庫的結構沒發生變化, 無需升級

針對 [介面資料庫] 的升級操作與上面類似, 不再贅述.

## 升級注意事項

每一個 sql 檔案都需要用 `Notepad++` 或 `Visual Studio Code` 等文字編輯器開啟, 閱讀頂部的匯入說明. 有時候一些特殊版本可能涉及到更為複雜的匯入策略, 會在每一個升級指令碼檔案的頂部進行單獨的說明.

此外, 資料備份也非常重要. 熊貓模擬器僅在每次版本釋出的時候, 在乾淨的資料庫環境中測試升級指令碼是可用的. 但並不對此進行任何的保證!! 因此, 當你自己嘗試對資料庫進行過結構變更, 那麼升級指令碼將無法保證 100% 相容你的資料庫, 升級過程可能會存在失敗的情況. 資料無價, 多備份一下總是好的.

當版本更新時, 若需要涉及升級資料的操作, 在 `changelog.md` 更新日誌中也會進行說明. 若沒有進行升級說明, 則表示該版本無需進行任何資料庫升級操作, 與其上個版本的資料庫結構完全相同.


相容老程式
============================================

從 v1.1.0 版本開始, rAthena 將物品資料庫從以前的 CSV 格式改造成 YAML 格式, 與此同時也修改了 SQL 版資料的欄位結構, 可以理解為 v1.0.9 版本和 v1.1.0 版本在 SQL 中的資料表完全是兩個東西. 但是, 歷史上我們會有很多外部程式, 例如 `FluxCP` 它會依賴 [主資料庫] 中的 `item_db{_re}` 或 `item_db2{_re}`  內容, 來向訪問站點的使用者提供物品資料庫的查詢服務. 當 rAthena 變更了這兩個表的資料結構之後, 毫無懸念的 `FluxCP` 物品資料庫查詢功能將會直接報錯.

為了在過渡期間解決對類似 `FluxCP` 等外部程式的相容問題, rAthena 提供了一套檢視程式指令碼, 用來對 `item_db{_re}` 或 `item_db2{_re}` 進行加工, 使之能變成回以前 `FluxCP` 能夠識別和解析的資料庫格式. 使用 "檢視" 的好處在於它將自動使用 `item_db{_re}` 或 `item_db2{_re}` 中的資料, 您無需在更新 `item_db{_re}` 或 `item_db2{_re}` 的內容時, 還去刻意更新專門用於相容的老資料表.

如果您有此需求, 請按以下步驟進行操作:

* 確保您已將 `item_db{_re}` 或 `item_db2{_re}` 升級到 v1.1.0 版本的結構
* 若您的程式編譯成了 `復興前` 版本, 那麼:
    * 請依序匯入 `sql-files\main\creation\use_sql_db\pre-renewal\optional` 目錄中的 sql 檔案
    * 完成後, 將會出現兩個新的檢視表: `item_db_compat` 和 `item_db2_compat`
* 若您的程式編譯成了 `復興後` 版本, 那麼:
    * 請依序匯入 `sql-files\main\creation\use_sql_db\renewal\optional` 目錄中的 sql 檔案
    * 完成後, 將會出現兩個新的檢視表: `item_db_re_compat` 和 `item_db2_re_compat`
* 配置你的 `FluxCP` 等外部工具, 使他們可以訪問對應的檢視表

> 小提示: 若您使用類似 Navicat 等資料庫管理工具時, 如果發現匯出檢視表後無法在 Tables 中找到檢視表, 這是正常的現象因為它並不是一個 "表", 因此請檢查 "檢視" 選項卡. 其他資料庫管理工具也同理. 由於 "檢視" 和 "資料表" 在查詢上沒有任何差異, 因此你可以將 "檢視" 也理解成為一種特殊的 "資料表".


輔助工具
============================================

rAthena 官方提供了一些奇奇怪怪的輔助指令碼, 通常在特定情況下有用. 由於實在是太低頻了, 因此熊貓模擬器的釋出版壓縮包中並沒有包含他們. 這些輔助指令碼 (或者說: 工具) 存放在熊貓模擬器的原始碼倉庫的 `sql-files\tools` 目錄中, 您可以隨時訪問: [https://github.com/PandasWS/Pandas/tree/master/sql-files/tools](https://github.com/PandasWS/Pandas/tree/master/sql-files/tools) 來下載使用它們.

雖然這些工具比較低頻, 但既然 rAthena 提供了我們也就介紹一下:

* convert_engine_innodb.sql - 將你的資料庫表引擎改成 InnoDB.
* convert_engine_myiasm.sql - 將你的資料庫表引擎改成 MyISAM.
* convert_passwords.sql - 將登陸表 (login) 的密碼欄位轉換成 MD5 (不可逆).

以下是一些輔助指令碼用來幫助大家把物品資料庫轉換成以前常見的 TXT 格式. 在使用這些指令碼之前, 需要提前做一些調整:

1. 先開啟你要執行的 sql 檔案, 修改其中 `INTO OUTFILE` 關鍵字後的 TXT 檔案輸出路徑
2. 執行這些 sql 檔案需要你的賬號擁有 [檔案](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html#priv_file) 許可權.
3. 此外, 還需要調整 MySQL 伺服器的配置的 [`secure-file-priv`](https://computingforgeeks.com/how-to-solve-mysql-server-is-running-with-the-secure-file-priv-error/) 選項
4. 隨後你才能正常的使用這些指令碼檔案 (對初學者真是不友好呀)

以下是幾個相關的 sql 檔案說明:

* item_db_re_to_txt.sql - 將 `復興後` 的物品資料庫錶轉換成 TXT 格式.
* item_db_to_txt.sql - 將 `復興前` 的物品資料庫錶轉換成 TXT 格式.
* item_db2_re_to_txt.sql - 將 `復興後` 的物品資料庫表 (import) 轉換成 TXT 格式.
* item_db2_to_txt.sql - 將 `復興前` 的物品資料庫表 (import) 轉換成 TXT 格式.

> 小提示: 建議不要在生產環境中調整 `secure-file-priv` 等配置, 並不是非常的安全. 可以在開發環境中搭建一個 MySQL 伺服器, 隨便折騰.
